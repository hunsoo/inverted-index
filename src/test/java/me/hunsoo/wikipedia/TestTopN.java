package me.hunsoo.wikipedia;

import me.hunsoo.wikipedia.TopNMapper;
import me.hunsoo.wikipedia.TopNReducer;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.io.LongWritable;
import org.apache.hadoop.io.NullWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mrunit.mapreduce.MapDriver;
import org.apache.hadoop.mrunit.mapreduce.MapReduceDriver;
import org.apache.hadoop.mrunit.mapreduce.ReduceDriver;
import org.junit.Before;
import org.junit.Test;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import static org.mockito.Mockito.*;

public class TestTopN {

    MapReduceDriver<LongWritable, Text, NullWritable, Text, NullWritable, Text> mapReduceDriver;
    MapDriver<LongWritable, Text, NullWritable, Text> mapDriver;
    ReduceDriver<NullWritable, Text, NullWritable, Text> reduceDriver;
    Configuration conf;

    @Before
    public void setup() {
        TopNMapper mapper = new TopNMapper();
        TopNReducer reducer = new TopNReducer();
        mapDriver = new MapDriver();
        mapDriver.setMapper(mapper);
        reduceDriver = new ReduceDriver();
        reduceDriver.setReducer(reducer);
        mapReduceDriver = new MapReduceDriver();
        mapReduceDriver.setMapper(mapper);
        mapReduceDriver.setReducer(reducer);
        mapDriver.getContext().getConfiguration().set("N", "3");
        reduceDriver.getContext().getConfiguration().set("N", "3");

        //when(mapDriver.getContext().getConfiguration().get("N")).thenReturn("3");
        when(reduceDriver.getContext().getNumReduceTasks()).thenReturn(1);
    }

    @Test
    public void testMapper() throws IOException {
        mapDriver.withInput(new LongWritable(1), new Text("java\t5592,5739,6282,6282,6734,6874,6734,5711,6220,6667,6698,6799,6600,5759,6840,5783,6734,6799,6734,6734,6828,8893,8996,8501,8129,8519,8586,8603,7532,7921,8667,8643,8218,7392,8667,7392,8129,8724,7538,8643,8378,8603,7519,7538,7538,8501,8667,8741,8082,7575,7985,7519,8743,8603,7392,8537,7800,8904,7519,8864,7800,9550,9331,9838,9966,9331,3397,4668,4086,2899,2899,4547,4086,2807,2899,4436,3965,4086,4135,3742,3965,3821,3365,4266,4674,4674,4373,4086,2779,1206,2142,1202,1988,2349,1847,1202,586,1202,1202,1202,1202,655,1202,1884,1202,1242"));
        mapDriver.withInput(new LongWritable(1), new Text("php\t8640,8137,7821,8824,8495,7252,8460,8406,7954,7821,7602,8137,7602,7940,8715,7672,7303,8429,7165,8466,8137,7925,8100,8953,7954,7602,8715,7259,7381,9232,9253,7602,7330,7446,8494,8246,8100,7772,8138,8407,7442,8935,9264,7602,8468,8886,7954,8748,7592,8715,7059,8811,8828,7331,7888,7783,8708,8650,9146,7592,7461,8603,7602,7213,8964,9121,8960,7612,8715,9258,7886,8828,7531,8506,7059,7534,8104,8886,9232,7951,8935,7851,8828,7994,8027,8406,7612,7246,7163,7309,8730,7242,8103,7602,8968,8968,7534,9087,7604,8663,7487,8695,8071,7697,7801,8886,8648,8029,8230,7978,7119,7222,8630,8742,8650,7602,8828,8778,7727,8953,8193,7053,7294,8837,7119,8300,7602,8781,7424,8300,8536,7305,8736,8884,8429,9030,7236,8651,8504,7635,7236,8222,8091,7246,8748,7045,7378,9252,7301,9258,8715,8651,8199,8945,7222,8884,8487,9118,8828,7487,8824,8592,7602,7602,7411,8402,7966,8774,8640,8964,8481,7437,8376,7564,9039,8828,7935,8311,9030,7241,9247,8465,7309,7329,7211,7131,7925,8079,7604,7044,8209,8367,7821,8603,7388,8079,8796,7573,7893,7424,8729,8470,8495,7940,7515,7400,9039,8594,572,1687,700,1847,2154,1701,1625,1162,746,2006,2006,736,1647,1970,2402,2402,1367,1367,1367,1847,969,1367,1526,1368,1453,1591,1701,1055,1701,2314,1441,2023,2023,956,701,700,983,2023,1950,2085,785,956,1973,2185,785,2251,2382,2009,2348,2251,1845,1730,1847,2382,2440,1536,925,1370,2441,1624,2422,1370,2441,1370,2441,2025,655,634,1851,2382,1897,1847,1017,1017,2443,1896,1078,1078,1078,1078,1078,1078,1193,852,2380,1078,803,1914,2217,2234,910,2217,1081,2193,1081,2064,910,2064,663,2444,2444,2444,2444,2563,2006,824,627,2444,791,1930,2006,1791,1252,1264,1466,2597,2457,340,957,957,957,2457,1171,849,1634,1790,2134,1726,2357,2049,1183,2383,1750,957,657,1980,2310,1183,1980,2321,651,600,336,2321,957,1313,1182,2130,1697,1132,2180,2130,1623,594,1347,1968,1980,1869,2006,1307,740,662,12,2018,1181,1362,1178,1933,2118,1578,1300,1216,2627,2082,1642,2006,2547,2313,2082,974,1625,1625,983,2009,1366,4721,4620,4378,4378,3722,4097,3722,3722,4614,4726,4726,3722,3335,3722,4098,4098,4098,4098,4727,4380,2957,2959,3333,3869,3869,4717,2944,3869,2944,4736,4381,4381,3295,4592,3477,4742,4384,4584,3338,4373,4312,3386,2668,2668,4715,4149,4149,4389,4569,4715,4715,4756,3263,4757,3013,3840,2792,3340,3022,3022,4647,4647,4551,3032,2639,3463,4550,2639,2925,3713,4364,4170,4547,3240,4547,4547,4547,3038,3343,3462,4777,2685,3233,3233,4778,4400,4650,2919,2919,2919,4363,3225,4188,3225,4285,4405,4519,4408,3845,4031,4693,4031,4061,4693,4693,3211,3211,3354,3699,4801,3408,3408,4802,3921,3408,3408,3457,4335,4335,4335,4335,3408,2899,3354,4359,3673,3757,2899,2899,3673,3673,4806,2701,4436,4436,3456,4497,2893,4810,3201,3410,3846,4356,3110,4668,3968,4489,4820,3198,3111,3198,4214,3681,3965,3846,3192,4670,4447,4447,3933,4218,2883,4449,4823,4674,4041,4827,4041,3447,3447,3356,3356,4471,2724,4468,4462,4911,4458,4458,4845,4457,4454,4456,4452,2717,4453,4840,4840,4840,9643,9317,9815,9640,9956,9672,9843,9857,9577,9966,9419,9966,9420,9518,9857,9514,9728,9426,9483,9325,9683,9926,9516,9441,9627,9518,9956,9591,9914,9591,9406,9640,9843,9615,9325,9808,9986,9549,9360,9988,9481,9966,9480,9643,9677,9518,9824,9643,9773,9555,9366,9382,9588,9403,9739,9592,9775,9790,9541,9683,9366,9724,9815,9541,9799,6260,5434,6598,6799,5453,6285,6322,6201,5663,6742,5312,5224,6886,6046,6046,6984,6433,5216,6201,6655,5796,6670,5907,5751,6220,6343,5176,4980,6343,6433,5334,6005,6927,5282,6343,6942,6014,5049,5233,5433,5615,5785,5197,5288,6696,6710,5778,6949,6019,5391,5840,6355,6623,5321,6314,7018,6943,5785,6198,6760,5729,5729,6827,6677,5163,5808,5249,6183,5194,5484,6187,6542,5593,6095,5751,6715,4986,5408,5693,6542,6859,5637,4941,5637,5020,5743,5199,4925,6621,5722,5693,5833,5688,6771,4930,5315,7030,5421,5696,6299,6585,6220,4917,6771,5278,6468,4918,6682,6176,5623,5921,5248,6746,6823,6046,6046,6201,5760,5216,6734,4967,6019,6821,5434,5551,6201,6181,6799,6201,6982,6752,6675,6986,6776,6443,5397,6986,5222,5574,6591,6859,6678,5626,5921,5401,5221,6878,6713,5574,6675,6451,5950,5882,5679,5759,5166,6881,4973,6700,5804,6260,6201,6516,5679,5222,6532,4964,5869"));
        mapDriver.withInput(new LongWritable(1), new Text("python\t8091,7951,7951,8091,7951,9069,8904,7575,7392,9069,8864,7962,8829,1624,2118,809,2142,809,2118,594,4320,4086,3963,2807,4320,2899,4320,3382,4266,6021,5783,6698,6667,5213,6698,9845,9685,9845,9685,9647,9685,9710,9845"));
        mapDriver.withOutput(NullWritable.get(), new Text("java 200"));
        mapDriver.withOutput(NullWritable.get(), new Text("php 500"));
        mapDriver.withOutput(NullWritable.get(), new Text("python 100"));
        mapDriver.runTest();
    }

    @Test
    public void testReducer() throws IOException {
        List<Text> phpList = new ArrayList();
        phpList.add(new Text("java 200"));
        List<Text> javaList = new ArrayList();
        javaList.add(new Text("java 200"));
        List<Text> pythonList = new ArrayList();
        pythonList.add(new Text("python 100"));

        reduceDriver.withInput(NullWritable.get(), phpList);
        reduceDriver.withInput(NullWritable.get(), javaList);
        reduceDriver.withInput(NullWritable.get(), pythonList);
        reduceDriver.withOutput(NullWritable.get(), new Text("php 500"));
        reduceDriver.withOutput(NullWritable.get(), new Text("java 200"));
        reduceDriver.withOutput(NullWritable.get(), new Text("python 100"));
        reduceDriver.runTest();
    }

    @Test
    public void testMapReduce() throws IOException {
        mapReduceDriver.withInput(new LongWritable(1), new Text("java\t5592,5739,6282,6282,6734,6874,6734,5711,6220,6667,6698,6799,6600,5759,6840,5783,6734,6799,6734,6734,6828,8893,8996,8501,8129,8519,8586,8603,7532,7921,8667,8643,8218,7392,8667,7392,8129,8724,7538,8643,8378,8603,7519,7538,7538,8501,8667,8741,8082,7575,7985,7519,8743,8603,7392,8537,7800,8904,7519,8864,7800,9550,9331,9838,9966,9331,3397,4668,4086,2899,2899,4547,4086,2807,2899,4436,3965,4086,4135,3742,3965,3821,3365,4266,4674,4674,4373,4086,2779,1206,2142,1202,1988,2349,1847,1202,586,1202,1202,1202,1202,655,1202,1884,1202,1242"));
        mapReduceDriver.withInput(new LongWritable(1), new Text("php\t8640,8137,7821,8824,8495,7252,8460,8406,7954,7821,7602,8137,7602,7940,8715,7672,7303,8429,7165,8466,8137,7925,8100,8953,7954,7602,8715,7259,7381,9232,9253,7602,7330,7446,8494,8246,8100,7772,8138,8407,7442,8935,9264,7602,8468,8886,7954,8748,7592,8715,7059,8811,8828,7331,7888,7783,8708,8650,9146,7592,7461,8603,7602,7213,8964,9121,8960,7612,8715,9258,7886,8828,7531,8506,7059,7534,8104,8886,9232,7951,8935,7851,8828,7994,8027,8406,7612,7246,7163,7309,8730,7242,8103,7602,8968,8968,7534,9087,7604,8663,7487,8695,8071,7697,7801,8886,8648,8029,8230,7978,7119,7222,8630,8742,8650,7602,8828,8778,7727,8953,8193,7053,7294,8837,7119,8300,7602,8781,7424,8300,8536,7305,8736,8884,8429,9030,7236,8651,8504,7635,7236,8222,8091,7246,8748,7045,7378,9252,7301,9258,8715,8651,8199,8945,7222,8884,8487,9118,8828,7487,8824,8592,7602,7602,7411,8402,7966,8774,8640,8964,8481,7437,8376,7564,9039,8828,7935,8311,9030,7241,9247,8465,7309,7329,7211,7131,7925,8079,7604,7044,8209,8367,7821,8603,7388,8079,8796,7573,7893,7424,8729,8470,8495,7940,7515,7400,9039,8594,572,1687,700,1847,2154,1701,1625,1162,746,2006,2006,736,1647,1970,2402,2402,1367,1367,1367,1847,969,1367,1526,1368,1453,1591,1701,1055,1701,2314,1441,2023,2023,956,701,700,983,2023,1950,2085,785,956,1973,2185,785,2251,2382,2009,2348,2251,1845,1730,1847,2382,2440,1536,925,1370,2441,1624,2422,1370,2441,1370,2441,2025,655,634,1851,2382,1897,1847,1017,1017,2443,1896,1078,1078,1078,1078,1078,1078,1193,852,2380,1078,803,1914,2217,2234,910,2217,1081,2193,1081,2064,910,2064,663,2444,2444,2444,2444,2563,2006,824,627,2444,791,1930,2006,1791,1252,1264,1466,2597,2457,340,957,957,957,2457,1171,849,1634,1790,2134,1726,2357,2049,1183,2383,1750,957,657,1980,2310,1183,1980,2321,651,600,336,2321,957,1313,1182,2130,1697,1132,2180,2130,1623,594,1347,1968,1980,1869,2006,1307,740,662,12,2018,1181,1362,1178,1933,2118,1578,1300,1216,2627,2082,1642,2006,2547,2313,2082,974,1625,1625,983,2009,1366,4721,4620,4378,4378,3722,4097,3722,3722,4614,4726,4726,3722,3335,3722,4098,4098,4098,4098,4727,4380,2957,2959,3333,3869,3869,4717,2944,3869,2944,4736,4381,4381,3295,4592,3477,4742,4384,4584,3338,4373,4312,3386,2668,2668,4715,4149,4149,4389,4569,4715,4715,4756,3263,4757,3013,3840,2792,3340,3022,3022,4647,4647,4551,3032,2639,3463,4550,2639,2925,3713,4364,4170,4547,3240,4547,4547,4547,3038,3343,3462,4777,2685,3233,3233,4778,4400,4650,2919,2919,2919,4363,3225,4188,3225,4285,4405,4519,4408,3845,4031,4693,4031,4061,4693,4693,3211,3211,3354,3699,4801,3408,3408,4802,3921,3408,3408,3457,4335,4335,4335,4335,3408,2899,3354,4359,3673,3757,2899,2899,3673,3673,4806,2701,4436,4436,3456,4497,2893,4810,3201,3410,3846,4356,3110,4668,3968,4489,4820,3198,3111,3198,4214,3681,3965,3846,3192,4670,4447,4447,3933,4218,2883,4449,4823,4674,4041,4827,4041,3447,3447,3356,3356,4471,2724,4468,4462,4911,4458,4458,4845,4457,4454,4456,4452,2717,4453,4840,4840,4840,9643,9317,9815,9640,9956,9672,9843,9857,9577,9966,9419,9966,9420,9518,9857,9514,9728,9426,9483,9325,9683,9926,9516,9441,9627,9518,9956,9591,9914,9591,9406,9640,9843,9615,9325,9808,9986,9549,9360,9988,9481,9966,9480,9643,9677,9518,9824,9643,9773,9555,9366,9382,9588,9403,9739,9592,9775,9790,9541,9683,9366,9724,9815,9541,9799,6260,5434,6598,6799,5453,6285,6322,6201,5663,6742,5312,5224,6886,6046,6046,6984,6433,5216,6201,6655,5796,6670,5907,5751,6220,6343,5176,4980,6343,6433,5334,6005,6927,5282,6343,6942,6014,5049,5233,5433,5615,5785,5197,5288,6696,6710,5778,6949,6019,5391,5840,6355,6623,5321,6314,7018,6943,5785,6198,6760,5729,5729,6827,6677,5163,5808,5249,6183,5194,5484,6187,6542,5593,6095,5751,6715,4986,5408,5693,6542,6859,5637,4941,5637,5020,5743,5199,4925,6621,5722,5693,5833,5688,6771,4930,5315,7030,5421,5696,6299,6585,6220,4917,6771,5278,6468,4918,6682,6176,5623,5921,5248,6746,6823,6046,6046,6201,5760,5216,6734,4967,6019,6821,5434,5551,6201,6181,6799,6201,6982,6752,6675,6986,6776,6443,5397,6986,5222,5574,6591,6859,6678,5626,5921,5401,5221,6878,6713,5574,6675,6451,5950,5882,5679,5759,5166,6881,4973,6700,5804,6260,6201,6516,5679,5222,6532,4964,5869"));
        mapReduceDriver.withInput(new LongWritable(1), new Text("python\t8091,7951,7951,8091,7951,9069,8904,7575,7392,9069,8864,7962,8829,1624,2118,809,2142,809,2118,594,4320,4086,3963,2807,4320,2899,4320,3382,4266,6021,5783,6698,6667,5213,6698,9845,9685,9845,9685,9647,9685,9710,9845"));
        reduceDriver.addOutput(NullWritable.get(), new Text("php 500"));
        reduceDriver.addOutput(NullWritable.get(), new Text("java 200"));
        reduceDriver.addOutput(NullWritable.get(), new Text("python 100"));
        mapReduceDriver.runTest();
    }
}
